<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> View的事件分发 · CCtomorrow</title><meta name="description" content="View的事件分发 - CCtomorrow"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://www.qingyongai.com/atom.xml" title="CCtomorrow"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">HOME</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="https://github.com/CCtomorrow" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">View的事件分发</h1><div class="post-info">2016-07-12</div><div class="post-content"><h3 id="前言"><a href="#前言" class="headerlink" title="前言:"></a>前言:</h3><p>最近写这两篇文章的原因是因为在自定义View的时候遇到有关事件分发的问题，然后自己怎么也想不通，最后决定自己看一遍源代码，那其实自己以前也有看过应该说很多的关于事件分发的文章，大概的东西也知道，但是对于有的事情还是模棱两可吧。<br>先说我遇到的问题吧，自定义ViewGroup里面有ImageView，我是想在ViewGroup里面去移动ImageView，发现当前的ViewGroup只能接收到DOWN事件(当然这个事件必须能接收到)，后续的事件都接收不到，这时候我就真的百思不得姐了，不是子View不消费事件，事件会让ViewGroup处理么，没问题啊，为什么会这样呢？<br>后来发现当给子View即ImageView设置Click事件之后，神奇的事情发生了，ImageView可以移动了，这两个问题围绕着我，那就想好好的把事件分发搞懂。</p>
<h3 id="dispatchTouchEvent"><a href="#dispatchTouchEvent" class="headerlink" title="dispatchTouchEvent"></a>dispatchTouchEvent</h3><p>首先我们要知道onTouchEvent事件是不需要我们处理的，系统以及帮我们处理了，当然我们可以重写这个方法。事件分发到View，肯定先走到dispatchTouchEvent中。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 代码是Android 6.0的</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> actionMasked = event.getActionMasked();</span><br><span class="line">    <span class="keyword">if</span> (onFilterTouchEventForSecurity(event)) &#123;</span><br><span class="line">    ListenerInfo li = mListenerInfo;</span><br><span class="line">    <span class="keyword">if</span> (li != <span class="keyword">null</span> &amp;&amp; li.mOnTouchListener != <span class="keyword">null</span></span><br><span class="line">    &amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED</span><br><span class="line">    &amp;&amp; li.mOnTouchListener.onTouch(<span class="keyword">this</span>, event)) &#123;</span><br><span class="line">            result = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!result &amp;&amp; onTouchEvent(event)) &#123;</span><br><span class="line">            result = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上面的代码是经过简化的。最终返回的是result，所以看哪几个地方result的值发生变化就好。</p>
<a id="more"></a>
<p><strong>由于代码量很小，可以很轻易的看出端倪，默认result是false的，就是不消费事件，<br>这里有两种情况result会返回true从而消费事件。</strong></p>
<ul>
<li>1.第一个条件<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">li != <span class="keyword">null</span> &amp;&amp; li.mOnTouchListener != <span class="keyword">null</span></span><br><span class="line">&amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED</span><br><span class="line">&amp;&amp; li.mOnTouchListener.onTouch(<span class="keyword">this</span>, event)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>这几个条件都要满足才会返回true。</p>
<p>1.1 li != null<br>ListenerInfo表示的是当前的View所有的一些监听，OnFocusChangeListener，OnTouchListener等等，一般不会为null。<br>1.2 mOnTouchListener != null<br>这个需要调用者自己设置，设置了才不为null。<br>1.3 (mViewFlags &amp; ENABLED_MASK) == ENABLED<br>当前的View的状态是Enable的，一般情况下是的，调用者可调用setEnabled来设置。<br>1.4 li.mOnTouchListener.onTouch(this, event)<br>OnTouch的返回值是否为true。</p>
<p>第一个条件分析:一般这个条件比较难的达到，主要是1.2和1.4需要调用者来控制。<br>如果条件达到，会返回true，消费掉事件，从而后面的代码就执行不到了，onTouchEvent就不会执行了，OnClick事件也不会执行了。</p>
<ul>
<li>2.(!result &amp;&amp; onTouchEvent(event))<br>既然都走到这里了result肯定是false的，!result为true了，然后事件消费与否看onTouchEvent的返回值了，这里说一下，一般onTouchEvent返回值都是为true的，下面会具体的分析，总的来说就是事件分发到View了，一般情况下会消费掉的。</li>
</ul>
<h3 id="onTouchEvent"><a href="#onTouchEvent" class="headerlink" title="onTouchEvent"></a>onTouchEvent</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 代码是Android 6.0的</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> action = event.getAction();</span><br><span class="line">    <span class="keyword">if</span> ((viewFlags &amp; ENABLED_MASK) == DISABLED) &#123;</span><br><span class="line">    <span class="keyword">return</span> (((viewFlags &amp; CLICKABLE) == CLICKABLE</span><br><span class="line">    || (viewFlags &amp; LONG_CLICKABLE) == LONG_CLICKABLE)</span><br><span class="line">    || (viewFlags &amp; CONTEXT_CLICKABLE) == CONTEXT_CLICKABLE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (((viewFlags &amp; CLICKABLE) == CLICKABLE</span><br><span class="line">    ||(viewFlags &amp; LONG_CLICKABLE) == LONG_CLICKABLE)</span><br><span class="line">    ||(viewFlags &amp; CONTEXT_CLICKABLE) == CONTEXT_CLICKABLE) &#123;</span><br><span class="line">    <span class="comment">// 省略代码</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>总体只有两个地方有返回，一个一个分析。</p>
<ul>
<li><p>(viewFlags &amp; ENABLED_MASK) == DISABLED<br>若一个View是disable的，如果它是CLICKABLE或者LONG_CLICKABLE或CONTEXT_CLICKABLE的就返回true，表示消耗掉了Touch事件。但是并不会执行到Click事件去。</p>
</li>
<li><p>((viewFlags &amp; CLICKABLE) == CLICKABLE||(viewFlags &amp; LONG_CLICKABLE) == LONG_CLICKABLE)||(viewFlags &amp; CONTEXT_CLICKABLE) == CONTEXT_CLICKABLE<br>和第一个条件一模一样的，除了当前View是enable的。</p>
</li>
</ul>
<p>不同的子View的clickable属性不同。比如：Button的clickable默认为true，但是TextView的clickable属性默认为false。View的longClickable属性默认为false。当然，我们可以通过代码修改这些默认的属性。<br>比如：setClickable()和setLongClickListener()可以改变View的CLICKABLE和LONG_CLICKABLE属性。除此以外，通过设置监听器也可改变某些属性。比如：setOnClickListener()会将View的CLICKABLE设置为true；setOnLongClickListener()会将View的LONG_CLICKABLE设置为true。</p>
<p>图示:<br><img src="/images/view_event_dispatch.png" alt="View事件分发"></p>
<h3 id="最后说一下总结"><a href="#最后说一下总结" class="headerlink" title="最后说一下总结"></a>最后说一下总结</h3><ol>
<li>OnTouch事件执行的条件是当前的控件是Enable的，并且设置了OnTouchListener。</li>
<li>OnTouch事件优先于OnTouchEvent事件，OnTouch返回true消费掉事件了，OnTouchEvent就不会执行了。</li>
<li>Action_up的时候处理点击事件。</li>
<li>怎么让View不消费事件:从上面分析到让View不消费事件就是OnTouchEvent返回fasle就可以了，如ImageView，如果放在一个ViewGroup里面，默认就不消费事件。</li>
</ol>
</div></article></div></main><footer><div class="paginator"><a href="/2016/07/14/Android_ViewGroup_Event_Dispatch/" class="prev">PREV</a><a href="/2016/06/02/Android_Custom_View_Implement_Weather_Line/" class="next">NEXT</a></div><div data-thread-key="2016/07/12/Android_View_Event_Dispatch/" data-title="View的事件分发" data-url="http://www.qingyongai.com/2016/07/12/Android_View_Event_Dispatch/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"[object Object]"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2015 - 2018 <a href="http://www.qingyongai.com">CCtomorrow</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>