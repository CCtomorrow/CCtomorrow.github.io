<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 热修复探究（一） · CCtomorrow</title><meta name="description" content="热修复探究（一） - CCtomorrow"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://www.qingyongai.com/atom.xml" title="CCtomorrow"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">HOME</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="https://github.com/CCtomorrow" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">热修复探究（一）</h1><div class="post-info">2016-07-27</div><div class="post-content"><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>这次博客会分两篇，这篇介绍各个Android版本是怎么反射加载生成的patch文件的，下篇会详细的分析class对比和patch的生成。</p>
<p>写这次文章的原因是因为最近在研究热修复，发现其实他们实现的代码很少，其实就一个类，然后里面针对不同的版本做反射处理，就想好好找找不同版本的对于类加载的机制。<br>其次呢，关于bug版本和修复版本的class文件对比，dex的patch文件生成的脚本也想了解一下。</p>
<h3 id="Android-ClassLoader区别"><a href="#Android-ClassLoader区别" class="headerlink" title="Android ClassLoader区别"></a>Android ClassLoader区别</h3><p>首先Android中加载类一般使用的是<code>PathClassLoader</code>和<code>DexClassLoader</code>。<br>区别:<br><code>PathClassLoader</code></p>
<ul>
<li>Android uses this class for its system class loader and for its application class<br>  loader(s).</li>
</ul>
<p>可以看出，Android是使用这个类作为其系统类和应用类的加载器。并且对于这个类呢，只能去加载已经安装到Android系统中的apk文件。</p>
<p><code>DexClassLoader</code></p>
<ul>
<li>A class loader that loads classes from {@code .jar} and {@code .apk} files<br>  containing a {@code classes.dex} entry. This can be used to execute code not<br>  installed as part of an application.</li>
</ul>
<p>可以看出，该类可以用来从.jar和.apk类型的文件内部加载classes.dex文件。可以用来执行非安装的程序代码。</p>
<p><code>DexClassLoader</code><br>构造函数：DexClassLoader(String dexPath, String optimizedDirectory, String libraryPath, ClassLoader parent)</p>
<ul>
<li>dexPath:被解压的dex路径，不能为空。</li>
<li>optimizedDirectory：解压后的.dex文件的存储路径，不能为空。这个路径强烈建议使用应用程序的私有路径，不要放到sdcard上，否则代码容易被注入攻击。</li>
<li>libraryPath：so库的存放路径，可以为空，若有so库，必须填写。</li>
<li>parent：父亲加载器，一般为context.getClassLoader(),使用当前上下文的类加载器。</li>
</ul>
<a id="more"></a>
<h3 id="不同版本的不同实现"><a href="#不同版本的不同实现" class="headerlink" title="不同版本的不同实现"></a>不同版本的不同实现</h3><p>我们会发现，根本找不到源代码，那其实代码在android_libcore里面。<br><a href="https://github.com/Evervolv/android_libcore" target="_blank" rel="noopener">https://github.com/Evervolv/android_libcore</a><br>这个库里面可以找到不同版本的lib_core的实现。</p>
<h4 id="Gingerbread-2-3-9"><a href="#Gingerbread-2-3-9" class="headerlink" title="Gingerbread 2.3 9"></a>Gingerbread 2.3 9</h4><p>首先看<strong>Gingerbread</strong>的实现，在2.3的时候PathClassLoader和DexClassLoader是分别实现的。着重看findClass方法。<br>PathClassLoader<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String path;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String[] mPaths;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> File[] mFiles;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ZipFile[] mZips;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> DexFile[] mDexs;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span>  <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException  &#123;</span><br><span class="line">    <span class="keyword">byte</span>[] data = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">int</span> length = mPaths.length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (mDexs[i] != <span class="keyword">null</span>) &#123;</span><br><span class="line">      Class clazz = mDexs[i].loadClassBinaryName(name, <span class="keyword">this</span>);</span><br><span class="line">      <span class="keyword">if</span> (clazz != <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> clazz;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mZips[i] != <span class="keyword">null</span>) &#123;</span><br><span class="line">      String fileName = name.replace(<span class="string">'.'</span>, <span class="string">'/'</span>) + <span class="string">".class"</span>;</span><br><span class="line">      data = loadFromArchive(mZips[i], fileName);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      File pathFile = mFiles[i];</span><br><span class="line">      <span class="keyword">if</span> (pathFile.isDirectory()) &#123;</span><br><span class="line">        String fileName =  mPaths[i] + <span class="string">"/"</span> +</span><br><span class="line">        name.replace(<span class="string">'.'</span>, <span class="string">'/'</span>) + <span class="string">".class"</span>;</span><br><span class="line">        data = loadFromDirectory(fileName);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException(name + <span class="string">" in loader "</span> + <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>The entries of the second list should be directories containing</li>
<li>native library files. Both lists are separated using the</li>
<li>character specified by the “path.separator” system property,</li>
<li>which, on Android, defaults to “:”.<br>里面有这段内容，就是说，dex文件路径存储在path里面，以分隔符分开，在Android里面分隔符是”:”。</li>
</ul>
<p>这里其实只能对mDexs[]处理，其余的zip，files并不能处理，后面有注释说明，详细的可以看源代码。</p>
<p>DexClassLoader<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> File[] mFiles; <span class="comment">// source file Files, for rsrc URLs</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ZipFile[] mZips; <span class="comment">// source zip files, with resources</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> DexFile[] mDexs; <span class="comment">// opened, prepped DEX files</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> length = mFiles.length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mDexs[i] != <span class="keyword">null</span>) &#123;</span><br><span class="line">            String slashName = name.replace(<span class="string">'.'</span>, <span class="string">'/'</span>);</span><br><span class="line">            Class clazz = mDexs[i].loadClass(slashName, <span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (VERBOSE_DEBUG)</span><br><span class="line">                    System.out.println(<span class="string">"    found"</span>);</span><br><span class="line">                <span class="keyword">return</span> clazz;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException(name + <span class="string">" in loader "</span> + <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到也只是可以从加载进来的dex文件里面找Class。</p>
<p>所以，热修复对他的反射处理如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Installer for platform versions 4 to 13.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">V4</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">install</span><span class="params">(ClassLoader loader, List&lt;File&gt; additionalClassPathEntries)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IllegalArgumentException, IllegalAccessException,</span></span><br><span class="line"><span class="function">            NoSuchFieldException, IOException </span>&#123;</span><br><span class="line">        <span class="comment">/* The patched class loader is expected to be a descendant</span></span><br><span class="line"><span class="comment">         * of dalvik.system.DexClassLoader. We modify its fields mPaths,</span></span><br><span class="line"><span class="comment">         * mFiles, mZips and mDexs to append additional DEX file entries.</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">int</span> extraSize = additionalClassPathEntries.size();</span><br><span class="line">        Field pathField = findField(loader, <span class="string">"path"</span>);</span><br><span class="line">        <span class="comment">// 旧的path</span></span><br><span class="line">  StringBuilder path = <span class="keyword">new</span> StringBuilder((String) pathField.get(loader));</span><br><span class="line">        String[] extraPaths = <span class="keyword">new</span> String[extraSize];</span><br><span class="line">        File[] extraFiles = <span class="keyword">new</span> File[extraSize];</span><br><span class="line">        ZipFile[] extraZips = <span class="keyword">new</span> ZipFile[extraSize];</span><br><span class="line">        DexFile[] extraDexs = <span class="keyword">new</span> DexFile[extraSize];</span><br><span class="line">        <span class="keyword">for</span> (ListIterator&lt;File&gt; iterator = additionalClassPathEntries.listIterator();</span><br><span class="line">             iterator.hasNext(); ) &#123;</span><br><span class="line">            File additionalEntry = iterator.next();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 添加新的dex文件路径到path里面</span></span><br><span class="line">  String entryPath = additionalEntry.getAbsolutePath();</span><br><span class="line">            path.append(<span class="string">':'</span>).append(entryPath);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> index = iterator.previousIndex();</span><br><span class="line">            extraPaths[index] = entryPath; <span class="comment">// paths</span></span><br><span class="line">  extraFiles[index] = additionalEntry; <span class="comment">// files</span></span><br><span class="line">  extraZips[index] = <span class="keyword">new</span> ZipFile(additionalEntry); <span class="comment">// zipfiles</span></span><br><span class="line">  extraDexs[index] = DexFile.loadDex(entryPath, entryPath + <span class="string">".dex"</span>, <span class="number">0</span>); <span class="comment">// dexfiles</span></span><br><span class="line">  &#125;</span><br><span class="line">        <span class="comment">// 重新设置path</span></span><br><span class="line">  pathField.set(loader, path.toString());</span><br><span class="line">        <span class="comment">// 重新设置mPaths，mFiles，mZips，mDexs</span></span><br><span class="line">  expandFieldArray(loader, <span class="string">"mPaths"</span>, extraPaths);</span><br><span class="line">        expandFieldArray(loader, <span class="string">"mFiles"</span>, extraFiles);</span><br><span class="line">        expandFieldArray(loader, <span class="string">"mZips"</span>, extraZips);</span><br><span class="line">        expandFieldArray(loader, <span class="string">"mDexs"</span>, extraDexs);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>实现即是这样的，其实很简单啦，就是把patch的dex文件路径加到path里面，再使用反射修改掉里面的四个字段，重新赋值。</p>
<h4 id="Ice-4-0-14"><a href="#Ice-4-0-14" class="headerlink" title="Ice 4.0 14"></a>Ice 4.0 14</h4><p>然后<strong>Ice</strong>的实现，看在4.0的具体实现。在4.0以后DexClassLoader和PathClassLoader都继承了BaseDexClassLoader，处理的代码都在BaseDexClassLoader里面。<br>BaseDexClassLoader<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">    Class clazz = pathList.findClass(name);</span><br><span class="line">    <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException(name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> clazz;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>代码很简洁，可以看到findClass是使用的DexPathList的实例，pathList去找到对应的class。<br>DexPathList里面的findClass<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Class <span class="title">findClass</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (Element element : dexElements) &#123;</span><br><span class="line">        DexFile dex = element.dexFile;</span><br><span class="line">        <span class="keyword">if</span> (dex != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Class clazz = dex.loadClassBinaryName(name, definingContext);</span><br><span class="line">            <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> clazz;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从dexElements里面寻找，所以需要使用反射修改掉dexElements，即dex数组文件。<br>相关实现如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Installer for platform versions 14, 15, 16, 17 and 18.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">V14</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">install</span><span class="params">(ClassLoader loader, List&lt;File&gt; additionalClassPathEntries, File optimizedDirectory)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IllegalArgumentException, IllegalAccessException,</span></span><br><span class="line"><span class="function">            NoSuchFieldException, InvocationTargetException, NoSuchMethodException </span>&#123;</span><br><span class="line">        <span class="comment">/* The patched class loader is expected to be a descendant</span></span><br><span class="line"><span class="comment">        of dalvik.system.BaseDexClassLoader. We modify its</span></span><br><span class="line"><span class="comment">        dalvik.system.DexPathList pathList field to append additional</span></span><br><span class="line"><span class="comment">        DEX file entries.</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        Field pathListField = findField(loader, <span class="string">"pathList"</span>);</span><br><span class="line">        Object dexPathList = pathListField.get(loader);</span><br><span class="line">        expandFieldArray(dexPathList, <span class="string">"dexElements"</span>,</span><br><span class="line">        makeDexElements(dexPathList,</span><br><span class="line">           <span class="keyword">new</span> ArrayList&lt;File&gt;(additionalClassPathEntries),</span><br><span class="line">                optimizedDirectory));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A wrapper around &#123;<span class="doctag">@code</span> private static final</span></span><br><span class="line"><span class="comment"> dalvik.system.DexPathList#makeDexElements&#125;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">static</span> Object[] makeDexElements(</span><br><span class="line">        Object dexPathList, ArrayList&lt;File&gt; files, File</span><br><span class="line">        optimizedDirectory)</span><br><span class="line">            <span class="keyword">throws</span> IllegalAccessException, InvocationTargetException,</span><br><span class="line">            NoSuchMethodException &#123;</span><br><span class="line">        Method makeDexElements =</span><br><span class="line">                findMethod(dexPathList, <span class="string">"makeDexElements"</span>,</span><br><span class="line">                ArrayList.class, File.class);</span><br><span class="line">        <span class="keyword">return</span> (Object[]) makeDexElements.invoke</span><br><span class="line">        (dexPathList, files, optimizedDirectory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>实现也挺简单，直接把我们要加的dex文件添加dexElements数组的最前面即可。</p>
<h4 id="kitkat-4-4-19"><a href="#kitkat-4-4-19" class="headerlink" title="kitkat 4.4 19"></a>kitkat 4.4 19</h4><p>BaseDexClassLoader<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">    List&lt;Throwable&gt; suppressedExceptions = <span class="keyword">new</span> ArrayList&lt;Throwable&gt;();</span><br><span class="line">    Class c = pathList.findClass(name, suppressedExceptions);</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">        ClassNotFoundException cnfe = <span class="keyword">new</span> ClassNotFoundException(<span class="string">"Didn't find class \""</span> + name + <span class="string">"\" on path: "</span> + pathList);</span><br><span class="line">        <span class="keyword">for</span> (Throwable t : suppressedExceptions) &#123;</span><br><span class="line">            cnfe.addSuppressed(t);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> cnfe;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>DexPathList<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Class <span class="title">findClass</span><span class="params">(String name, List&lt;Throwable&gt; suppressed)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (Element element : dexElements) &#123;</span><br><span class="line">        DexFile dex = element.dexFile;</span><br><span class="line">        <span class="keyword">if</span> (dex != <span class="keyword">null</span>) &#123;</span><br><span class="line">          Class clazz = dex.loadClassBinaryName(name, definingContext,</span><br><span class="line">            suppressed);</span><br><span class="line">            <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> clazz;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (dexElementsSuppressedExceptions != <span class="keyword">null</span>) &#123;</span><br><span class="line">       suppressed.addAll(Arrays.asList(dexElementsSuppressedExceptions));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到只是新增了一些异常，合成dex文件的时候需要传递多一个参数用来存储找寻每个dex文件发生异常IO信息。<br>对应的处理:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Installer for platform versions 19.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">V19</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">install</span><span class="params">(ClassLoader loader, List&lt;File&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">    additionalClassPathEntries, File optimizedDirectory)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IllegalArgumentException, IllegalAccessException,</span></span><br><span class="line"><span class="function">            NoSuchFieldException, InvocationTargetException,</span></span><br><span class="line"><span class="function">            NoSuchMethodException </span>&#123;</span><br><span class="line">        <span class="comment">/* The patched class loader is expected to be a descendant of</span></span><br><span class="line"><span class="comment">         * dalvik.system.BaseDexClassLoader. We modify its</span></span><br><span class="line"><span class="comment">         * dalvik.system.DexPathList pathList field to append additional</span></span><br><span class="line"><span class="comment">         * DEX file entries.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Field pathListField = findField(loader, <span class="string">"pathList"</span>);</span><br><span class="line">        Object dexPathList = pathListField.get(loader);</span><br><span class="line">        ArrayList&lt;IOException&gt; suppressedExceptions = <span class="keyword">new</span></span><br><span class="line">        ArrayList&lt;IOException&gt;();</span><br><span class="line">        expandFieldArray(dexPathList, <span class="string">"dexElements"</span>,</span><br><span class="line">        makeDexElements(dexPathList,</span><br><span class="line">        <span class="keyword">new</span> ArrayList&lt;File&gt;(additionalClassPathEntries),</span><br><span class="line">        optimizedDirectory, suppressedExceptions));</span><br><span class="line">        <span class="keyword">if</span> (suppressedExceptions.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (IOException e : suppressedExceptions) &#123;</span><br><span class="line">                Log.w(TAG, <span class="string">"Exception in makeDexElement"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">            Field suppressedExceptionsField =</span><br><span class="line">                    findField(dexPathList, <span class="string">"dexElementsSuppressedExceptions"</span>);</span><br><span class="line">            IOException[] dexElementsSuppressedExceptions =</span><br><span class="line">                    (IOException[]) suppressedExceptionsField.get(dexPathList);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (dexElementsSuppressedExceptions == <span class="keyword">null</span>) &#123;</span><br><span class="line">                dexElementsSuppressedExceptions =</span><br><span class="line">                        suppressedExceptions.toArray(</span><br><span class="line">                                <span class="keyword">new</span> IOException[suppressedExceptions.size()]);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                IOException[] combined =</span><br><span class="line">                        <span class="keyword">new</span> IOException[suppressedExceptions.size() +</span><br><span class="line">                                dexElementsSuppressedExceptions.length];</span><br><span class="line">                suppressedExceptions.toArray(combined);</span><br><span class="line">                System.arraycopy(dexElementsSuppressedExceptions, <span class="number">0</span>, combined,</span><br><span class="line">                        suppressedExceptions.size(), dexElementsSuppressedExceptions.length);</span><br><span class="line">                dexElementsSuppressedExceptions = combined;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            suppressedExceptionsField.set(dexPathList, dexElementsSuppressedExceptions);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A wrapper around</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@code</span> private static final</span></span><br><span class="line"><span class="comment">     dalvik.system.DexPathList#makeDexElements&#125;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">static</span> Object[] makeDexElements(</span><br><span class="line">            Object dexPathList, ArrayList&lt;File&gt; files, File optimizedDirectory,</span><br><span class="line">            ArrayList&lt;IOException&gt; suppressedExceptions)</span><br><span class="line">            <span class="keyword">throws</span> IllegalAccessException, InvocationTargetException,</span><br><span class="line">            NoSuchMethodException &#123;</span><br><span class="line">        Method makeDexElements =</span><br><span class="line">                findMethod(dexPathList, <span class="string">"makeDexElements"</span>, ArrayList.class, File.class,</span><br><span class="line">                        ArrayList.class);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (Object[]) makeDexElements.invoke(dexPathList, files, optimizedDirectory,</span><br><span class="line">                suppressedExceptions);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>makeDexElements方法作了反射调用，并且如果找寻我们自己的新增dex出了问题也会去把做异常处理，最终会对dexElementsSuppressedExceptions这个异常数组做处理。<br>5.X的这部分代码并没有什么差别。</p>
<p>关于6.0和7.0的，这里并没有代码，现在就不分析，找到代码会继续分析。其实思路很简单，一个版本一个版本的去对比findClass的实现的差别，然后调整反射调用的代码。</p>
<p>具体可以看Github上面的两个开源库:<br><a href="https://github.com/bunnyblue/DroidFix" target="_blank" rel="noopener">https://github.com/bunnyblue/DroidFix</a></p>
<p><a href="https://github.com/dodola/RocooFix" target="_blank" rel="noopener">https://github.com/dodola/RocooFix</a></p>
<p>这里的代码都是取自那里，这篇文章分析热修复加载dex的部分，下篇会分析，CLASS_ISPREVERIFIED的实现，即class对比和patch的生成。</p>
<p>关于6.X的，有看到源代码，发现和5.X的基本一样，不明白作者为什么在V19和V23使用了两种不同的反射方式去实现，可能是在实践中踩出来的经验吧。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2016/08/02/Android_HotFix_two/" class="prev">上一篇</a><a href="/2016/07/23/github_fork_and_sync_the_last code/" class="next">下一篇</a></div><div data-thread-key="2016/07/27/Android_HotFix_one/" data-title="热修复探究（一）" data-url="http://www.qingyongai.com/2016/07/27/Android_HotFix_one/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"[object Object]"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2015 - 2018 <a href="http://www.qingyongai.com">CCtomorrow</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>