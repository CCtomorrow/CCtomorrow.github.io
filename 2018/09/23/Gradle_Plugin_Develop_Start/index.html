<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Android Gradle插件开发介绍 · CCtomorrow</title><meta name="description" content="Android Gradle插件开发介绍 - CCtomorrow"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://www.qingyongai.com/atom.xml" title="CCtomorrow"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">HOME</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="https://github.com/CCtomorrow" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Android Gradle插件开发介绍</h1><div class="post-info">2018-09-23</div><div class="post-content"><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>其实很早就想聊一聊Android Gradle插件的开发了，这次终于开始啦。Android Gradle插件是Google开发的一个用于编译打包安卓apk的插件，其实也就是一个gradle插件而已，我们这里讲的Android Gradle插件的开发是基于gradle以及Android Gradle(例如<code>com.android.application</code>)插件的再次开发，开发的方式基本都是在Android Gradle的task之前、之间或者之后插入一些我们的自定义的task等等，主要是为了实现我们想要的一些功能。</p>
<h3 id="基础与参考"><a href="#基础与参考" class="headerlink" title="基础与参考"></a>基础与参考</h3><p>本文章不讲基础，麻烦自己去看对应的文章，我这里会列出来我认为比较好的开发Gradle插件的资料。<strong>当然这些基础的前提也是要对Gradle有所了解</strong><br><a href="https://docs.gradle.org/current/userguide/custom_plugins.html#custom_plugins" target="_blank" rel="noopener">Writing Custom Plugins</a><br><a href="https://gradle.org/guides/?q=Plugin%20Development" target="_blank" rel="noopener">Plugin Development Guides</a><br><a href="https://chaosleong.gitbooks.io/gradle-for-android/content/advanced_build_customization/manipulating_tasks.html" target="_blank" rel="noopener">操作Task</a><br><a href="http://fucknmb.com/2017/07/05/%E5%8F%88%E6%8E%8C%E6%8F%A1%E4%BA%86%E4%B8%80%E9%A1%B9%E6%96%B0%E6%8A%80%E8%83%BD-%E6%96%AD%E7%82%B9%E8%B0%83%E8%AF%95Gradle%E6%8F%92%E4%BB%B6/" target="_blank" rel="noopener">断点调试Gradle插件</a><br><a href="https://linxiaotao.github.io/2018/05/21/Gradle%E6%8F%92%E4%BB%B6-%E6%8F%90%E9%AB%98%E7%AF%87/" target="_blank" rel="noopener">Gradle插件-提高篇</a><br><a href="https://juejin.im/post/5b02113a5188254289190671" target="_blank" rel="noopener">写给Android开发者的Gradle系列三</a></p>
<h3 id="在你的插件里面应用别人的插件"><a href="#在你的插件里面应用别人的插件" class="headerlink" title="在你的插件里面应用别人的插件"></a>在你的插件里面应用别人的插件</h3><p>有时候我们会想，我在项目里面又需要应用google的安卓插件，又需要应用自己开发的插件，那么我们可以不可以直接使用我们自己的插件，然后在我们自己的插件里面应用google的安卓插件呢，当然是可以的了。<br>如下就可以搞定了，是不是很简单<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">project.apply <span class="string">plugin:</span> AppPlugin</span><br><span class="line"><span class="comment">//project.apply plugin: 'com.android.application'//换成这个也可以，因为他们代表的是同一个东西，如果理解不了，请看上面的基础文章</span></span><br></pre></td></tr></table></figure></p>
<p>不过这种方式有一个缺点，由于gradle是边读取边解释的，所以如果我们想在<code>void apply(Project project)</code>一执行就读取android的配置，那么我们在项目的build.gradle里面应用我们的插件的位置就要放在<code>android {}</code>代码块之后，像下面这样。<br><img src="/images/gradle_plugin_order.png" alt="apply位置"><br>如果这样的话，就不能在我们的插件里面apply安卓gradle插件啦。因为安卓gradle插件的apply语句要放在<code>android {}</code>代码块之前的，因为extension的定义要在apply插件之后的。</p>
<h3 id="自定义插件修改bugly热修复的tinkerId配置"><a href="#自定义插件修改bugly热修复的tinkerId配置" class="headerlink" title="自定义插件修改bugly热修复的tinkerId配置"></a>自定义插件修改bugly热修复的tinkerId配置</h3><p>了解bugly的热修复的人，知道他是利用的tinker，然后bugly写了自己的gradle插件，当然这个插件里面依赖了tinker的gradle插件。<br>用热修复就涉及到多渠道的问题，一般不管多少渠道，我们的代码都是同一套的，意思就是说我们可以使用同一个补丁包，bugly博客也专门写了一篇文章来讲解怎么去做。<br><a href="https://buglydevteam.github.io/2017/05/15/solution-of-multiple-channel-hotpatch/" target="_blank" rel="noopener">Bugly多渠道热更新解决方案</a><br>那我们公司比较特殊，开发人员只会给运营同事打几个不同名称的apk包给运营，然后由运营利用我们开发的一个打包工具，加上他们想要的渠道名称，进行二次打包，那这样的话，就会有一些问题了，打不同名称的apk需要用到多渠道打包，这样再加上使用bugly插件那么最后生成的apk包每个渠道的tinkerId都不一样，但是我们只是apk名称改了，其他代码资源没有任何操作，这样的话其实可以使用同一个补丁包的。<br>这种情况就想到自己再次开发一个gradle插件，在bugly插件对应的task后面添加task，然后重新生成tinkerId。<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LinghitBuglyManifestPlugin</span> <span class="keyword">implements</span> <span class="title">Plugin</span>&lt;<span class="title">Project</span>&gt; &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> apply(Project project) &#123;</span><br><span class="line">        project.apply <span class="string">plugin:</span> AppPlugin</span><br><span class="line">        <span class="comment">//不是Application项目不执行</span></span><br><span class="line">        <span class="keyword">if</span> (!project.plugins.hasPlugin(AppPlugin)) &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//应用bugly的插件，必须要先应用，Gradle是边读取边解释，所以下面的LinghitHotFixExtension只能在项目评估完成之后</span></span><br><span class="line">        project.apply <span class="string">plugin:</span> TinkerSupportPlugin</span><br><span class="line">        project.extensions.create(<span class="string">"LHotFix"</span>, LinghitHotFixExtension)</span><br><span class="line">        LinghitHotFixExtension fixExtension = project.extensions.LHotFix</span><br><span class="line">        AppExtension android = project.extensions.getByType(AppExtension.<span class="keyword">class</span>)</span><br><span class="line">        project.afterEvaluate &#123;</span><br><span class="line">            <span class="comment">//不需要热修复的话，直接return</span></span><br><span class="line">            <span class="keyword">if</span> (!fixExtension.enable) &#123;</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//如果把这个代码放在这里的话后面拿tinkerSupport的task是拿不到的</span></span><br><span class="line">            <span class="comment">//project.apply plugin: TinkerSupportPlugin</span></span><br><span class="line">            <span class="comment">//参数</span></span><br><span class="line">            <span class="keyword">def</span> format = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MMdd-HHmm"</span>)</span><br><span class="line">            <span class="keyword">def</span> id = <span class="string">"APP-$&#123;android.defaultConfig.versionName&#125;-$&#123;android.defaultConfig.versionCode&#125;-$&#123;format.format(new Date())&#125;"</span></span><br><span class="line">            <span class="keyword">def</span> bakPath = <span class="string">"$&#123;project.getProjectDir()&#125;/bakApk/"</span></span><br><span class="line">            <span class="keyword">def</span> patchOutDir = <span class="string">"$&#123;project.getProjectDir()&#125;/patch/"</span></span><br><span class="line">            <span class="keyword">def</span> extension = project.extensions.getByType(TinkerSupportExtension)</span><br><span class="line">            extension.enable = <span class="literal">true</span></span><br><span class="line">            extension.autoGenerateTinkerId = <span class="literal">false</span></span><br><span class="line">            <span class="comment">//上面设置为true，这个就不起作用了</span></span><br><span class="line">            extension.tinkerId = id</span><br><span class="line">            extension.autoBackupApkDir = bakPath</span><br><span class="line">            extension.patchOutputDir = patchOutDir</span><br><span class="line">            extension.overrideTinkerPatchConfiguration = <span class="literal">true</span></span><br><span class="line">            extension.baseApk = <span class="string">"$&#123;bakPath&#125;$&#123;fixExtension.oldApk&#125;app-release.apk"</span></span><br><span class="line">            extension.baseApkProguardMapping = <span class="string">"$&#123;bakPath&#125;$&#123;fixExtension.oldApk&#125;app-release-mapping.txt"</span></span><br><span class="line">            extension.baseApkResourceMapping = <span class="string">"$&#123;bakPath&#125;$&#123;fixExtension.oldApk&#125;app-release-R.txt"</span></span><br><span class="line">            extension.buildAllFlavorsDir = <span class="string">"$&#123;bakPath&#125;/$&#123;fixExtension.oldApk&#125;"</span></span><br><span class="line">            extension.isProtectedApp = fixExtension.isProtectedApp</span><br><span class="line">            extension.enableProxyApplication = <span class="literal">true</span></span><br><span class="line">            extension.supportHotplugComponent = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">            project.getLogger().error(<span class="string">"tinker old apk:$&#123;project.extensions.tinkerPatch.oldApk&#125;"</span>)</span><br><span class="line"></span><br><span class="line">            project.getLogger().error(<span class="string">"buglyTinker old apk:$&#123;project.extensions.tinkerSupport.baseApk&#125;"</span>)</span><br><span class="line"></span><br><span class="line">            android.applicationVariants.all &#123; ApplicationVariantImpl variant -&gt;</span><br><span class="line">                String variantName = variant.name.capitalize()</span><br><span class="line">                ApkVariantData variantData = variant.variantData</span><br><span class="line">                ProductFlavor flavor = variant.mergedFlavor</span><br><span class="line">                BaseVariantOutput output = variant.outputs.first()</span><br><span class="line">                ManifestProcessorTask mpTask = output.processManifest</span><br><span class="line">                ProcessAndroidResources rpTask = output.processResources</span><br><span class="line">                TinkerSupportManifestTask tmpTask = project.tasks.getByName(<span class="string">"tinkerSupportProcess$&#123;variantName&#125;Manifest"</span>)</span><br><span class="line">                LinghitManifestTask lmpTask = project.tasks.create(<span class="string">"linghitProcess$&#123;variantName&#125;Manifest"</span>, LinghitManifestTask)</span><br><span class="line">                <span class="keyword">if</span> (mpTask.properties[<span class="string">'manifestOutputFile'</span>] != <span class="literal">null</span>) &#123;</span><br><span class="line">                    lmpTask.manifestPath = mpTask.manifestOutputFile</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rpTask.properties[<span class="string">'manifestFile'</span>] != <span class="literal">null</span>) &#123;</span><br><span class="line">                    lmpTask.manifestPath = rpTask.manifestFile</span><br><span class="line">                &#125;</span><br><span class="line">                lmpTask.finalTinkerId = extension.tinkerId</span><br><span class="line">                lmpTask.mustRunAfter(tmpTask)</span><br><span class="line">                rpTask.dependsOn lmpTask</span><br><span class="line">                <span class="comment">//project.getLogger().error("variantName:$&#123;variantName&#125;")</span></span><br><span class="line">                project.getLogger().error(<span class="string">"插件要处理的manifestPath:$&#123;lmpTask.manifestPath&#125;"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LinghitManifestTask</span> <span class="keyword">extends</span> <span class="title">DefaultTask</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span></span><br><span class="line">    <span class="keyword">final</span> String MANIFEST_XML = <span class="string">"build/intermediates/l_bugly_intermediates/AndroidManifest.xml"</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span></span><br><span class="line">    <span class="keyword">final</span> String TINKER_ID = <span class="string">"TINKER_ID"</span></span><br><span class="line"></span><br><span class="line">    String manifestPath</span><br><span class="line">    String finalTinkerId</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> LinghitManifestTask() &#123;</span><br><span class="line">        group = <span class="string">'l-tinker-support'</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TaskAction</span></span><br><span class="line">    <span class="keyword">def</span> updateManifest() &#123;</span><br><span class="line">        <span class="keyword">def</span> ns = <span class="keyword">new</span> Namespace(<span class="string">"http://schemas.android.com/apk/res/android"</span>, <span class="string">"android"</span>)</span><br><span class="line">        <span class="keyword">def</span> isr = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">def</span> pw = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            isr = <span class="keyword">new</span> InputStreamReader(<span class="keyword">new</span> FileInputStream(manifestPath), <span class="string">"utf-8"</span>)</span><br><span class="line">            <span class="keyword">def</span> xml = <span class="keyword">new</span> XmlParser().parse(isr)</span><br><span class="line">            getLogger().error(<span class="string">"manifestPath：$&#123;manifestPath&#125;"</span>)</span><br><span class="line">            <span class="comment">//def application = xml.application[0]</span></span><br><span class="line">            <span class="keyword">def</span> application = xml.application[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">def</span> oldId</span><br><span class="line">            <span class="keyword">if</span> (application) &#123;</span><br><span class="line">                <span class="keyword">def</span> metaDataTags = application[<span class="string">'meta-data'</span>]</span><br><span class="line">                <span class="comment">// find TINKER_ID elements</span></span><br><span class="line">                metaDataTags.findAll &#123;</span><br><span class="line">                    it.attributes()[ns.name].equals(TINKER_ID)</span><br><span class="line">                &#125;.each &#123;</span><br><span class="line">                    <span class="comment">//App_oppo-release-2.1.2.212_0922-23-11-02</span></span><br><span class="line">                    oldId = it.attributes()[ns.value]</span><br><span class="line">                    it.parent().remove(it)</span><br><span class="line">                &#125;</span><br><span class="line">                getLogger().error(<span class="string">"Remove $&#123;TINKER_ID&#125;：$&#123;oldId&#125;"</span>)</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Add the new TINKER_ID element</span></span><br><span class="line">                application.appendNode(<span class="string">'meta-data'</span>, [(ns.name): TINKER_ID, (ns.value): finalTinkerId])</span><br><span class="line"></span><br><span class="line">                getLogger().error(<span class="string">"Add New $&#123;TINKER_ID&#125;：$&#123;finalTinkerId&#125;"</span>)</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Write the manifest file</span></span><br><span class="line">                pw = <span class="keyword">new</span> PrintWriter(manifestPath, <span class="string">"utf-8"</span>)</span><br><span class="line">                <span class="keyword">def</span> printer = <span class="keyword">new</span> XmlNodePrinter(pw)</span><br><span class="line">                printer.preserveWhitespace = <span class="literal">true</span></span><br><span class="line">                printer.print(xml)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            StreamUtil.closeQuietly(pw)</span><br><span class="line">            StreamUtil.closeQuietly(isr)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        File manifestFile = <span class="keyword">new</span> File(manifestPath)</span><br><span class="line">        <span class="keyword">if</span> (manifestFile.exists()) &#123;</span><br><span class="line">            FileOperation.copyFileUsingStream(manifestFile, project.file(MANIFEST_XML))</span><br><span class="line">            project.logger.error(<span class="string">"linghit bugly support gen AndroidManifest.xml in $&#123;MANIFEST_XML&#125;"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></article></div></main><footer><div class="paginator"><a href="/2018/08/05/Replugin_Communication/" class="next">NEXT</a></div><div data-thread-key="2018/09/23/Gradle_Plugin_Develop_Start/" data-title="Android Gradle插件开发介绍" data-url="http://www.qingyongai.com/2018/09/23/Gradle_Plugin_Develop_Start/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"[object Object]"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2015 - 2018 <a href="http://www.qingyongai.com">CCtomorrow</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>